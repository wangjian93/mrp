<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>MRP数据</title>
    <link rel="stylesheet" href="../../../assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="../../../assets/module/admin.css?v=318"/>
    <!--[if lt IE 9]>
    <script src="../../../assets/libs/html5shiv/html5shiv.min.js"></script>
    <script src="../../../assets/libs/respond/respond.min.js"></script>
    <![endif]-->

    <!-- 表格单元格高宽 -->
    <style>
        .mrp .layui-table-view .layui-table td .layui-table-cell,
        .mrp .layui-table-view .layui-table[lay-size="sm"] td .layui-table-cell {
            height: auto;
            padding: 0px 0px;
        }
        .mrp .layui-table-view .layui-table th .layui-table-cell,
        .mrp .layui-table-view .layui-table[lay-size="sm"] th .layui-table-cell {
            height: auto;
            padding: 0px 0px;
        }

        .mrp .layui-table-view .layui-table td,
        .mrp .layui-table-view .layui-table th {
            padding: 0px 0px;
        }
    </style>
    <!-- 移取layui表格鼠标悬停事件 -->
    <style>
        .layui-table tbody tr:hover, .layui-table-click, .layui-table-hover {
            background-color: transparent;
        }
        .layui-table td{
            border-color: #736e6e;
        }
    </style>

    <!-- 表格单元格样式 -->
    <style>
        div .box_parent {
            display: inline-block;
            vertical-align: top;
        }
        div .box {
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */
            -webkit-box-sizing:border-box; /* Safari */
            border-top: none;
            border-left: none;
            border-bottom: 1px #99c7e8 solid;
            border-right: 1px #99c7e8 solid;
            height: 20px;
            width: 100px;
        }
        div .box_parent.hover:hover {
            background-color: lightyellow;
            cursor:pointer
        }
        div .box.hover:hover {
            background-color: #f2ffb4;
        }
    </style>
</head>
<body>

<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header"><i class="layui-icon layui-icon-tabs"></i> LCM包材 MRP数据</div>
        <div class="layui-card-body">
            <div class="layui-collapse">
                <div class="layui-colla-item">
                    <h2 class="layui-colla-title">注意：以下几种没有BOM List</h2>
                    <div class="layui-colla-content">
                        <table id="node" lay-filter="node"></table>
                    </div>
                </div>
            </div>

            <br/>

            <!-- MRP表格 -->
            <div class="mrp">
                <!-- 表格工具栏 -->
                <div class="layui-form toolbar">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">机种:</label>
                            <div class="layui-input-inline">
                                <input name="product" class="layui-input" type="text" placeholder="查询机种"/>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">物料组:</label>
                            <div class="layui-input-inline">
                                <input name="materialGroup" class="layui-input" type="text" placeholder="查询物料组"/>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">料号:</label>
                            <div class="layui-input-inline">
                                <input name="material" class="layui-input" type="text" placeholder="查询料号"/>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label w-auto">供应商:</label>
                            <div class="layui-input-inline">
                                <input name="supplier" class="layui-input" type="text" placeholder="查询供应商"/>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <button class="layui-btn icon-btn layui-btn-sm" lay-filter="search" lay-submit>
                                <i class="layui-icon">&#xe615;</i>搜索
                            </button>

                            <!-- 导出下拉按钮 -->
                            <div class="dropdown-menu" style="margin-left: 10px;">
                                <button class="layui-btn icon-btn layui-btn-sm" type="button">
                                    <i class="layui-icon">&#xe67d;</i>导出<i class="layui-icon layui-icon-drop right"></i>
                                </button>
                                <ul class="dropdown-menu-nav dropdown-right-center">
                                    <li><a id="bt_export">搜索结果</a></li>
                                    <li><a id="bt_exportAll">全部数据</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <table id="table_mrp" lay-filter="table_mrp"></table>
            </div>
        </div>
    </div>
</div>


<!-- MRP日历模板 -->
<script type="text/html" id="mrpCalendarDemo"><div class="box_parent">
<div class="box" style="border-bottom:none;border-right:1px solid #e6e6e6;">{{d.day}}</div>
<div class="box" style="border-bottom:none;border-right:1px solid #e6e6e6;">{{d.week}}</div>
</div></script>

<!-- MRP月份日历模板 -->
<script type="text/html" id="mrpCalendarMonthDemo"><div class="box_parent" style="height: 40px;">
<div class="box" style="border-bottom:none;border-right:1px solid #e6e6e6;line-height: 40px;height: 40px;">{{d.month}}</div>
</div></script>

<!-- MRP行数据label模板 -->
<script type="text/html" id="mrpTitleDemo"><div class="box_parent">
<div class="box" style="width: 160px;">需求量</div>
<div class="box" style="color: #01AAED;width: 160px;">到货量</div>
<div class="box" style="color: red;border-bottom: none;width: 160px;background-color: #87CEFA">结余量</div>
<div class="box" style="color: red;width: 160px;" hidden>缺料量</div>
<div class="box" style="width: 160px;" hidden>分配量</div>
</div></script>

<!-- MRP行数据label模板 -->
<script type="text/html" id="mrpTitleDemo_Alone"><div class="box_parent">
{{#  layui.each(d.productList, function(index, item){ }}
<div class="box" style="width: 160px;">{{ item }}</div>
{{#  }); }}
<div class="box" style="color: #01AAED;width: 160px;">到货量</div>
<div class="box" style="color: red;border-bottom: none;width: 160px;background-color:#87CEFA">结余量</div>
<div class="box" style="color: red;width: 160px;" hidden>缺料量</div>
<div class="box" style="width: 160px;" hidden>分配量</div>
</div></script>

<!-- MRP月份汇总数据模板 -->
<script type="text/html" id="mrpMonthDemo"><div class="box_parent" id="{{ d.material_month }}">
<div class="box" id="{{ d.material_product_month }}_demandQty"></div>
<div class="box" id="{{ d.material_product_month }}_arrivalQty"></div>
<div class="box" id="{{ d.material_product_month }}_balanceQty" style="border-bottom: none;background-color: #87CEFA"></div>
<div class="box" id="{{ d.material_product_month }}_shortQty" hidden></div>
<div class="box" id="{{ d.material_product_month }}_allocationQty" hidden></div>
</div></script>

<script type="text/html" id="mrpMonthDemo_Alone"><div class="box_parent" id="{{ d.material_month }}">
{{#  layui.each(d.productList, function(index, item){ }}
<div class="box">-</div>
{{#  }); }}
<div class="box" id="{{ d.material_month }}_arrivalQty"></div>
<div class="box" id="{{ d.material_month }}_balanceQty" style="border-bottom: none;background-color:#87CEFA"></div>
<div class="box" id="{{ d.material_month }}_shortQty" hidden></div>
<div class="box" id="{{ d.material_month }}_allocationQty" hidden></div>
</div></script>

<!-- MRP行数据模板 -->
<script type="text/html" id="mrpDemo"><div class="box_parent hover" id="{{ d.material_product_fabDate }}">
<div class="box hover" id="{{ d.material_product_fabDate }}_demandQty"  lay-event="{{ d.material_product_fabDate }}_demandQty"></div>
<div class="box hover" id="{{ d.material_product_fabDate }}_arrivalQty"  lay-event="{{ d.material_product_fabDate }}_arrivalQty"></div>
<div class="box hover" id="{{ d.material_product_fabDate }}_balanceQty"  lay-event="{{ d.material_product_fabDate }}_balanceQty" style="border-bottom: none;background-color: #87CEFA"></div>
<div class="box hover" id="{{ d.material_product_fabDate }}_shortQty"  lay-event="{{ d.material_product_fabDate }}_shortQty" hidden></div>
<div class="box hover" id="{{ d.material_product_fabDate }}_allocationQty"  lay-event="{{ d.material_product_fabDate }}_allocationQty" hidden></div>
</div></script>

<script type="text/html" id="mrpDemo_Alone"><div class="box_parent hover" id="{{ d.material_fabDate }}">
{{#  layui.each(d.productList, function(index, item){ }}
<div class="box" id="{{ d.material_fabDate }}_demandQty_product_{{ item }}"></div>
{{#  }); }}
<div class="box hover" id="{{ d.material_fabDate }}_arrivalQty"  lay-event="{{ d.material_fabDate }}_arrivalQty"></div>
<div class="box hover" id="{{ d.material_fabDate }}_balanceQty"  lay-event="{{ d.material_fabDate }}_balanceQty" style="border-bottom: none;background-color: #87CEFA"></div>
<div class="box hover" id="{{ d.material_fabDate }}_shortQty"  lay-event="{{ d.material_fabDate }}_shortQty" hidden></div>
<div class="box hover" id="{{ d.material_fabDate }}_allocationQty"  lay-event="{{ d.material_fabDate }}_allocationQty" hidden></div>
</div></script>

<!-- 需求量明细弹框 -->
<script type="text/html" id="demandQtyDetailDialog">
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="table_demandQtyDetail" lay-filter="table_demandQtyDetail"></table>
        </div>
    </div>
</script>

<!-- 到货量明细弹框 -->
<script type="text/html" id="arrivalQtyDetailDialog">
    <div class="layui-card">
        <div class="layui-card-body">
            <label>计划到货</label>
            <table id="table_arrivalQtyDetail" lay-filter="table_arrivalQtyDetail"></table>
            <label>实际收货</label>
            <table id="table_actualArrivalQtyDetail" lay-filter="table_actualArrivalQtyDetail"></table>

        </div>
    </div>
</script>

<!-- 供应商分配数量明细弹框 -->
<script type="text/html" id="allocationQtyDetailDialog">
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="table_allocationQtyDetail" lay-filter="table_allocationQtyDetail"></table>
        </div>
    </div>
</script>

<!-- js部分 -->
<script type="text/javascript" src="../../../assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="../../../assets/js/common.js?v=318"></script>
<script>
    layui.use(['flow', 'table', 'laytpl', 'admin', 'form', 'element', 'dropdown', 'tableX', 'tableX2'], function() {
        var $ = layui.$;
        var flow = layui.flow;
        var table = layui.table;
        var laytpl = layui.laytpl;
        var admin = layui.admin;
        var form = layui.form;
        var element = layui.element;
        var tableX = layui.tableX;
        var tableX2 = layui.tableX2;

        /* 获取URL请求的参数 */
        var getQueryVariable = function (variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0;i<vars.length;i++) {
                var pair = vars[i].split("=");
                if(pair[0] === variable){return pair[1];}
            }
            return(false);
        };
        var ver = getQueryVariable("ver");
        if(!ver) {
            layer.msg("未能获取MRP的版本");
        }

        //获取MRP的日历
        var getMrpCalendar = function(ver) {
            var calendar = {};
            $.ajaxSettings.async = false;
            $.get('/mrp/mrp/getMrpCalendar', {ver: ver}, function(res) {
                if(res.code === 200) {
                    calendar = res.data;
                } else {
                    layer.msg("获取MRP的日历失败，"+res.msg)
                }
            });
            $.ajaxSettings.async = true;
            return calendar;
        };
        var calendar = getMrpCalendar(ver);
        var weeks = calendar.weeks;
        var months = calendar.months;
        var days = calendar.days;

        //计算MRP表格的日历
        var calendarTitleLi = [];
        for(var i=0; i<days.length; i++) {
            var d = {
                day: days[i],
                week: weeks[i]
            };
            calendarTitleLi.push(laytpl(mrpCalendarDemo.innerHTML).render(d));
        }
        var calendarTitle = '<div style="white-space: nowrap;">'+calendarTitleLi.join("")+'</div>';

        var calendarMonthTitleLi = [];
        for(var i=0; i<months.length; i++) {
            var d = {
                month: months[i]
            };
            calendarMonthTitleLi.push(laytpl(mrpCalendarMonthDemo.innerHTML).render(d));
        }
        var calendarMonthTitle = '<div style="white-space: nowrap;">'+calendarMonthTitleLi.join("")+'</div>';

        //MRP数据表格
        table.render({
            elem: '#table_mrp',
            url: '/mrp/packageLcm/getPageMrpPackageLcmMaterial',
            where: {
                ver: ver
            },
            cols: [[
                {type: 'numbers', align: 'center', fixed: 'left'},
                {title: '机种', align: 'center', width: 160, fixed: 'left', templet: function(d) {
                        var productVars = d.products.split(",");
                        var productStr = "";
                        for(var i=0; i<productVars.length; i++) {
                            var p = productVars[i].substring(0, 4)+""+productVars[i].substring(7, 8)+"-R"+ productVars[i].substring(9, 10);
                            if(productStr !== "") {
                                productStr += "<br>";
                            }
                            productStr += p;
                        }

                        return '<div style="max-height: 60px;overflow-y:auto;">'+productStr+'</div>';
                    }},
                {field: 'material', title: '<div style="line-height: 40px;">料号</div>', align: 'center', width: 140, fixed: 'left'},
                {title: 'BOM用量', align: 'center', width: 100, fixed: 'left'},
                {title: '物料名', align: 'center', width: 160, fixed: 'left', templet: function (d) {
                        return '<div style="max-width: 150px;white-space:normal; word-break:break-all;overflow:hidden;">'+d.materialName+'</div>';
                    }},
                {title: '', align: 'center', width: 160, fixed: 'left', templet: function(d) {
                        if(d.alone) {
                            d.productList = d.products.split(",");
                            return laytpl(mrpTitleDemo_Alone.innerHTML).render(d);
                        } else {
                            return laytpl(mrpTitleDemo.innerHTML).render(d);
                        }
                    }
                },
                {field: 'suppliers', title: '供应商', align: 'center', width: 160,templet: function(d) {
                        if(d.suppliers != null) {
                            return '<div style="max-height: 60px;overflow-y:auto;">'+d.suppliers.replace(/,/g,"<br>")+'</div>';
                        } else {
                            return '';
                        }
                    }},
                {field: 'materialGroup', title: '物料组', align: 'center', width: 80},
                //{field: 'materialGroupName', title: '物料组名', align: 'center', width: 100},
                {field: 'fab', title: '厂别', align: 'center', width: 80},
                // {field: 'lossRate', title: '损耗率', align: 'center', width: 80},
                {field: 'goodInventory', title: '良品库存', align: 'center', width: 80},
                // {field: 'dullInventory', title: '呆滞库存', align: 'center', width: 80},
                // {field: 'inventorDate', title: '库存日期', align: 'center', width: 140},
                // {field: 'supplierCodes', title: '供应商', align: 'center', width: 140},
                // {field: 'customers', title: '客户', align: 'center', width: 140},
                // {field: 'createDate', title: '创建时间', align: 'center', width: 140},
                {title: calendarMonthTitle, align: 'center', width: months.length*100,
                    templet: function(data) {
                        var material = data.material;
                        //料号中会有'.'jquery的ID选择器选不到
                        material = material.replace(".","point");

                        if(data.alone) {
                            var id = 'mrp_month_'+material;
                            var productList = data.products.split(",");
                            return '<div id="'+id+'" style="white-space: nowrap;height: '+(20*(productList.length+2))+'px;"></div>';
                        } else {
                            var product = data.products;
                            var id = 'mrp_month_'+material+'_'+product;
                            return '<div id="'+id+'" style="white-space: nowrap;height: 60px;"></div>';
                        }
                    }
                },
                {title: calendarTitle, align: 'center', width: days.length*100,
                    templet: function(data) {
                        var material = data.material;
                        //料号中会有'.'jquery的ID选择器选不到
                        material = material.replace(".","point");

                        if(data.alone) {
                            var id = 'mrp_'+material;
                            var productList = data.products.split(",");
                            return '<div id="'+id+'" style="white-space: nowrap;height: '+(20*(productList.length+2))+'px;"></div>';
                        } else {
                            var product = data.products;
                            var id = 'mrp_'+material+'_'+product;
                            return '<div id="'+id+'" style="white-space: nowrap;height: 60px;"></div>';
                        }
                    }
                }
            ]],
            done: function(res, curr, count) {
                layui.each(res.data, function(index, item){
                    var material = item.material;
                    var alone = item.alone;
                    var products = item.products;
                    renderMaterialMrp(material, alone, products);
                });
                //单元格合并
                // tableX.merges('table_mrp', [4], ["products"]);
                tableX2.merges('table_mrp', [1], ["products"]);
            },
            page: true,
            limit: 100,
            limits: [20, 50, 100, 200, 300, 400, 500, 1000],
            size: 'sm',
            height: 'full-20',
            even: true
        });


        //料号的MRP数据渲染
        var renderMaterialMrp = function(material, alone, products) {
            var product = alone ? "":products;
            $.get('/mrp/packageLcm/getMrpPackageLcm',{
                ver: ver,
                material: material,
                product: product
            }, function(res){
                //料号中会有'.'jquery的ID选择器选不到
                var material_ = material.replace(".","point");
                var lis = [];
                layui.each(days, function(i, day) {
                    if(alone) {
                        var d = {
                            material_fabDate: material_+"_"+day,
                            productList: products.split(",")
                        };
                        lis.push(laytpl(mrpDemo_Alone.innerHTML).render(d));
                    } else {
                        var d = {
                            material_product_fabDate: material_+"_"+product+"_"+day
                        };
                        lis.push(laytpl(mrpDemo.innerHTML).render(d));
                    }
                });
                if(alone) {
                    var id = 'mrp_'+material_;
                    $('#'+id).html(lis.join(""));
                } else {
                    var id = 'mrp_'+material_+"_"+products;
                    $('#'+id).html(lis.join(""));
                }


                //月份汇总
                var lisMonth = [];
                layui.each(months, function(i, month) {
                    if(alone) {
                        var d = {
                            material_month: material_+"_"+month,
                            productList: products.split(",")
                        };
                        lisMonth.push(laytpl(mrpMonthDemo_Alone.innerHTML).render(d));
                    } else {
                        var d = {
                            material_product_month: material_+"_"+product+"_"+month
                        };
                        lisMonth.push(laytpl(mrpMonthDemo.innerHTML).render(d));
                    }
                });
                if(alone) {
                    var id_month = 'mrp_month_'+material_;
                    $('#'+id_month).html(lisMonth.join(""));
                } else {
                    var id_month = 'mrp_month_'+material_+"_"+products;
                    $('#'+id_month).html(lisMonth.join(""));
                }

                var monthSum = {};
                layui.each(res.data.mrpData, function(index, item) {
                    if(alone) {
                        var material_fabDate = material_+"_"+item.fabDate;
                        // var demandQty = item.demandQty===0?'':item.demandQty;
                        // $('#'+material_fabDate+"_demandQty").html('<span>'+demandQty+'</span>');
                        // var lossQty = item.lossQty===0?'':item.lossQty;
                        // $('#'+material_fabDate+"_lossQty").html('<span>'+lossQty+'</span>');
                        var arrivalQty = item.arrivalQty===0?'':item.arrivalQty;

                        var nowDay = new Date();
                        var fd = new Date(item.fabDate);
                        if(nowDay.getTime() > fd.getTime()) {
                            $('#'+material_fabDate+"_arrivalQty").html('<span style="color: black;">'+arrivalQty+'</span>');
                        } else {
                            $('#'+material_fabDate+"_arrivalQty").html('<span style="color: #01AAED;">'+arrivalQty+'</span>');
                        }

                        var balanceQty = item.balanceQty===0?'':item.balanceQty;
                        if(item.balanceQty<0) {
                            $('#'+material_fabDate+"_balanceQty").html('<span style="color: red">'+balanceQty+'</span>');
                        } else {
                            $('#'+material_fabDate+"_balanceQty").html('<span>'+balanceQty+'</span>');
                        }
                        if(item.modifyBalanceFlag) {
                            $('#'+material_fabDate+"_balanceQty").css("background-color", "#FFB800");
                        }

                        var shortQty = item.shortQty===0?'':item.shortQty;
                        $('#'+material_fabDate+"_shortQty").html('<span style="color: red">'+shortQty+'</span>');

                        var allocationQty = item.allocationQty===0?'':item.allocationQty;
                        $('#'+material_fabDate+"_allocationQty").html('<span>'+allocationQty+'</span>');

                        var fabDate = item.fabDate;
                        var month = fabDate.substring(0, 7);
                        if(!monthSum[month]) {
                            monthSum[month] = {
                                demandQty: 0,
                                lossQty: 0,
                                arrivalQty: 0,
                                balanceQty: 0,
                                shortQty: 0,
                                allocationQty: 0
                            };
                        }
                        monthSum[month].demandQty += item.demandQty;
                        monthSum[month].lossQty += item.lossQty;
                        monthSum[month].arrivalQty += item.arrivalQty;
                        monthSum[month].shortQty += item.shortQty;
                        monthSum[month].allocationQty += item.allocationQty;
                        monthSum[month].balanceQty = item.balanceQty;
                    } else {
                        var material_product_fabDate = material_+"_"+product+"_"+item.fabDate;
                        var demandQty = item.demandQty===0?'':item.demandQty;
                        $('#'+material_product_fabDate+"_demandQty").html('<span>'+demandQty+'</span>');
                        // var lossQty = item.lossQty===0?'':item.lossQty;
                        // $('#'+material_product_fabDate+"_lossQty").html('<span>'+lossQty+'</span>');
                        var arrivalQty = item.arrivalQty===0?'':item.arrivalQty;

                        var nowDay = new Date();
                        var fd = new Date(item.fabDate);
                        if(nowDay.getTime() > fd.getTime()) {
                            $('#'+material_product_fabDate+"_arrivalQty").html('<span style="color: black;">'+arrivalQty+'</span>');
                        } else {
                            $('#'+material_product_fabDate+"_arrivalQty").html('<span style="color: #01AAED;">'+arrivalQty+'</span>');
                        }

                        var balanceQty = item.balanceQty===0?'':item.balanceQty;
                        if(item.balanceQty<0) {
                            $('#'+material_product_fabDate+"_balanceQty").html('<span style="color: red">'+balanceQty+'</span>');
                        } else {
                            $('#'+material_product_fabDate+"_balanceQty").html('<span>'+balanceQty+'</span>');
                        }
                        if(item.modifyBalanceFlag) {
                            $('#'+material_product_fabDate+"_balanceQty").css("background-color", "#FFB800");
                        }

                        var shortQty = item.shortQty===0?'':item.shortQty;
                        $('#'+material_product_fabDate+"_shortQty").html('<span style="color: red">'+shortQty+'</span>');

                        var allocationQty = item.allocationQty===0?'':item.allocationQty;
                        $('#'+material_product_fabDate+"_allocationQty").html('<span>'+allocationQty+'</span>');

                        var fabDate = item.fabDate;
                        var month = fabDate.substring(0, 7);
                        if(!monthSum[month]) {
                            monthSum[month] = {
                                demandQty: 0,
                                lossQty: 0,
                                arrivalQty: 0,
                                balanceQty: 0,
                                shortQty: 0,
                                allocationQty: 0
                            };
                        }
                        monthSum[month].demandQty += item.demandQty;
                        monthSum[month].lossQty += item.lossQty;
                        monthSum[month].arrivalQty += item.arrivalQty;
                        monthSum[month].shortQty += item.shortQty;
                        monthSum[month].allocationQty += item.allocationQty;
                        monthSum[month].balanceQty = item.balanceQty;
                    }
                });

                layui.each(Object.keys(monthSum), function(index, month) {
                    if(alone) {
                        var material_month = material_+"_"+month;
                        var monthData = monthSum[month];
                        $('#'+material_month+"_demandQty").html('<span>'+monthData.demandQty+'</span>');
                        $('#'+material_month+"_lossQty").html('<span>'+monthData.lossQty+'</span>');
                        $('#'+material_month+"_arrivalQty").html('<span style="color:#01AAED;">'+monthData.arrivalQty+'</span>');
                        if(monthData.balanceQty < 0) {
                            $('#'+material_month+"_balanceQty").html('<span style="color:red">'+monthData.balanceQty+'</span>');
                        } else {
                            $('#'+material_month+"_balanceQty").html('<span>'+monthData.balanceQty+'</span>');
                        }
                        $('#'+material_month+"_shortQty").html('<span>'+monthData.shortQty+'</span>');
                        $('#'+material_month+"_allocationQty").html('<span>'+monthData.allocationQty+'</span>');
                    } else {
                        var material_product_month = material_+"_"+product+"_"+month;
                        var monthData = monthSum[month];
                        $('#'+material_product_month+"_demandQty").html('<span>'+monthData.demandQty+'</span>');
                        $('#'+material_product_month+"_lossQty").html('<span>'+monthData.lossQty+'</span>');
                        $('#'+material_product_month+"_arrivalQty").html('<span style="color:#01AAED;">'+monthData.arrivalQty+'</span>');
                        if(monthData.balanceQty < 0) {
                            $('#'+material_product_month+"_balanceQty").html('<span style="color:red">'+monthData.balanceQty+'</span>');
                        } else {
                            $('#'+material_product_month+"_balanceQty").html('<span>'+monthData.balanceQty+'</span>');
                        }
                        $('#'+material_product_month+"_shortQty").html('<span>'+monthData.shortQty+'</span>');
                        $('#'+material_product_month+"_allocationQty").html('<span>'+monthData.allocationQty+'</span>');
                    }
                });

                if(alone) {
                    layui.each(res.data.demandDate, function(index, item) {
                        var id= material_+"_"+item.fabDate+"_demandQty_product_"+item.product;
                        $("#"+id).html(item.demandQty);
                    });
                }
            });
        };

        // 表格搜索
        form.on('submit(search)', function(data) {
            table.reload('table_mrp', {
                where: {
                    ver: ver,
                    searchProduct: data.field.product,
                    searchMaterialGroup: data.field.materialGroup,
                    searchMaterial: data.field.material,
                    searchSupplier: data.field.supplier
                },
                page: {curr: 1}
            });
            return false;
        });

        //监听表格点击
        table.on('tool(table_mrp)', function(obj) {
            var material;
            var product;
            var fabDate;
            var label;
            var ars = obj.event.split("_");
            material = ars[0];
            //料号中会有'.'jquery的ID选择器选不到
            material = material.replace("point",".");
            if(ars.length === 3) {
                fabDate = ars[1];
                label = ars[2];
            } else {
                product = ars[1];
                fabDate = ars[2];
                label = ars[3];
            }

            switch(label) {
                case 'demandQty':
                    // showDemandQtyDetail(material,fabDate);
                    break;
                case 'arrivalQty':
                    showArrivalQtyDetail(material, product, fabDate);
                    break;
                case 'balanceQty':
                    editBalanceQty(material, product, fabDate);
                    break;
            }
        });

        //显示需求量明细
        var showDemandQtyDetail = function(material, fabDate) {
            admin.open({
                type: 1,
                title: '需求量明细',
                content: $('#demandQtyDetailDialog').html(),
                area: '1030px',
                success: function (layero, dIndex) {
                    table.render({
                        elem: '#table_demandQtyDetail',
                        url: '/mrp/demand/getDemandByMaterial',
                        where: {
                            ver: ver,
                            material: material,
                            fabDate: fabDate
                        },
                        cols: [[
                            {type: 'numbers', align: 'center', totalRowText: '合计'},
                            {field: 'type', title: '类型', align: 'center', width: 80},
                            {field: 'dpsMpsVer', title: '版本', align: 'center', width: 120},
                            {field: 'fab', title: '厂别', align: 'center', width: 80},
                            {field: 'product', title: '机种', align: 'center', width: 160},
                            {field: 'project', title: 'PROJECT', align: 'center', width: 100},
                            {field: 'qty', title: '投入量', align: 'center', width: 80},
                            {field: 'usageQty', title: 'BOM使用量', align: 'center', width: 100},
                            {field: 'substituteRate', title: '替代比例(%)', align: 'center', width: 120},
                            {field: 'demandQty', title: '需求量', align: 'center', totalRow: true}
                        ]],
                        page: {layout: ['count']},
                        height: 300,
                        width: 1000,
                        size: 'sm',
                        even: true,
                        totalRow: true
                    });
                }
            });
        };

        //显示到货量明细
        var showArrivalQtyDetail = function(material, product, fabDate) {
            admin.open({
                type: 1,
                title: '供应商到货',
                content: $('#arrivalQtyDetailDialog').html(),
                area: '750px',
                btn: ['提交', '取消'],
                success: function (layero, dIndex) {
                    table.render({
                        elem: '#table_arrivalQtyDetail',
                        url: '/mrp/arrivalPlan/getArrivalQtyByMaterial2',
                        where: {
                            ver: ver,
                            material: material,
                            fabDate: fabDate
                        },
                        cols: [[
                            {type: 'numbers', align: 'center', totalRowText: '合计'},
                            {field: 'fab', title: '厂别', align: 'center', width: 80},
                            {field: 'material', title: '料号', align: 'center', width: 120},
                            {field: 'fabDate', title: '日期', align: 'center', width: 120},
                            {field: 'supplierCode', title: '供应商ID', align: 'center', width: 120},
                            {field: 'supplierSname', title: '供应商', align: 'center', width: 120},
                            {field: 'arrivalQty', title: '计划到货量', align: 'center', totalRow: true, edit: 'number', "event": "dataCol"}
                        ]],
                        page: {layout: ['count']},
                        width: 720,
                        size: 'sm',
                        even: true,
                        totalRow: true
                    });
                    //将layui表格的编辑框改成Number
                    table.on('tool(table_arrivalQtyDetail)', function(obj){
                        if (obj.event === "dataCol"){
                            $("table input").attr("type","number");
                            $("table input").attr("step","1");
                        }
                    });

                    table.render({
                        elem: '#table_actualArrivalQtyDetail',
                        url: '/mrp/actualArrival/getActualArrival',
                        where: {
                            ver: ver,
                            material: material,
                            fabDate: fabDate
                        },
                        cols: [[
                            {type: 'numbers', align: 'center', totalRowText: '合计'},
                            {field: 'werks', title: '厂别', align: 'center', width: 80},
                            {field: 'material', title: '料号', align: 'center', width: 120},
                            {field: 'fabDate', title: '日期', align: 'center', width: 120},
                            {field: 'supplierCode', title: '供应商ID', align: 'center', width: 120},
                            {field: 'supplierName', title: '供应商', align: 'center', width: 120},
                            {field: 'qty', title: '实际收货', align: 'center', totalRow: true}
                        ]],
                        page: {layout: ['count']},
                        width: 720,
                        size: 'sm',
                        even: true,
                        totalRow: true
                    });
                },
                yes: function(index, layero) {
                    $.post('/mrp/arrivalPlan/batchSaveArrivalQty', {
                        jsons: JSON.stringify(table.cache["table_arrivalQtyDetail"])
                    }, function(res) {
                        if(res.code === 200) {
                            $.get('/mrp/packageLcm/updateMrpPackageMaterial', {
                                ver: ver,
                                product: product,
                                material: material
                            }, function(res) {
                                if(res.code === 200) {
                                    layer.close(index);
                                    //料号中会有'.'jquery的ID选择器选不到
                                    var material_ = material.replace(".", "point");
                                    var id;
                                    var mrp_month;
                                    if (product) {
                                        id = 'mrp_' + material_ + "_" + product;
                                        mrp_month = 'mrp_month' + material_ + "_" + product;
                                        $('#' + id).html('<div>加载中</div>');
                                        $('#' + mrp_month).html('<div>加载中</div>');
                                        renderMaterialMrp(material, false, product);
                                    } else {
                                        id = 'mrp_' + material_;
                                        mrp_month = 'mrp_month' + material_;
                                        $('#' + id).html('<div>加载中</div>');
                                        $('#' + mrp_month).html('<div>加载中</div>');
                                        renderMaterialMrp(material, true, product);
                                    }
                                } else {
                                    layer.msg("MRP更新失败，"+res.msg);
                                    layer.close(index);
                                }
                            });
                        } else {
                            layer.msg("提交失败，"+res.msg)
                        }
                    });
                }
            });
        };

        //修改料号的结余量
        var editBalanceQty = function(material, product, fabDate) {
            var material_ = material.replace(".","point");
            var material_fabDate = material_ + "_" + fabDate;
            var material_product_fabDate = material_ +"_"+product+"_" + fabDate;

            var id;
            if(product) {
                id = material_product_fabDate;
            } else {
                id = material_fabDate;
            }

            var span = $('#'+id+"_balanceQty span:first-child");
            span.hide();
            var oldValue = span.html();
            $('#'+id+"_balanceQty").append('<input style="height:20px;" class="layui-input"/>');
            var input = $('#'+id+"_balanceQty  input:last-child");
            input.focus();
            input.val(oldValue);
            input.blur(function(){
                var d = input.val();
                if(d === "" || d===oldValue) {
                    $('#'+id+"_balanceQty  input").remove();
                    span.show();
                } else {
                    $('#'+id+"_balanceQty  input").remove();
                    span.html(d);
                    span.show();
                    $.get('/mrp/packageLcm/updateMrpPackageBalanceQty', {
                        ver: ver,
                        material: material,
                        product: product,
                        fabDate: fabDate,
                        balanceQty: d
                    }, function(res) {
                        if(res.code === 200) {
                            //料号中会有'.'jquery的ID选择器选不到
                            var material_ = material.replace(".", "point");
                            var id;
                            var mrp_month;
                            if (product) {
                                id = 'mrp_' + material_ + "_" + product;
                                mrp_month = 'mrp_month' + material_ + "_" + product;
                                $('#' + id).html('<div>加载中</div>');
                                $('#' + mrp_month).html('<div>加载中</div>');
                                renderMaterialMrp(material, false, product);
                            } else {
                                id = 'mrp_' + material_;
                                mrp_month = 'mrp_month' + material_;
                                $('#' + id).html('<div>加载中</div>');
                                $('#' + mrp_month).html('<div>加载中</div>');
                                renderMaterialMrp(material, true, product);
                            }
                        } else {
                            layer.msg("结余量修改失败,"+res.msg)
                        }
                    });
                }
            });
            input.keydown(function(event){
                if (event.keyCode == 13){ //回车事件
                    input.blur();
                }
            });
            input.click(function(event){
                input.blur();
                event.stopPropagation();
            });
        };

        //缺料分配明细
        var showAllocationQty = function(material,fabDate) {
            admin.open({
                type: 1,
                title: '供应商数量分配',
                content: $('#allocationQtyDetailDialog').html(),
                area: '750px',
                btn: ['提交', '取消'],
                success: function (layero, dIndex) {
                    table.render({
                        elem: '#table_allocationQtyDetail',
                        url: '/mrp/allocation/getAllocationQtyByMaterial2',
                        where: {
                            ver: ver,
                            material: material,
                            fabDate: fabDate
                        },
                        cols: [[
                            {type: 'numbers', align: 'center', totalRowText: '合计'},
                            {field: 'fab', title: '厂别', align: 'center', width: 80},
                            {field: 'material', title: '料号', align: 'center', width: 120},
                            {field: 'fabDate', title: '日期', align: 'center', width: 120},
                            {field: 'supplierCode', title: '供应商ID', align: 'center', width: 120},
                            {field: 'supplierSname', title: '供应商', align: 'center', width: 120},
                            {field: 'allocationQty', title: '分配数量', align: 'center', totalRow: true, edit: 'number', "event": "dataCol"}
                        ]],
                        page: {layout: ['count']},
                        height: 300,
                        width: 720,
                        size: 'sm',
                        even: true,
                        totalRow: true
                    });
                    //将layui表格的编辑框改成Number
                    table.on('tool(table_allocationQtyDetail)', function(obj){
                        if (obj.event === "dataCol"){
                            $("table input").attr("type","number");
                            $("table input").attr("step","1");
                        }
                    });
                },
                yes: function(index, layero) {
                    $.post('/mrp/allocation/batchSaveAllocation', {
                        jsons: JSON.stringify(table.cache["table_allocationQtyDetail"])
                    }, function(res) {
                        if(res.code === 200) {
                            $.get('/mrp/mrp/updateMrpAllocationQty', {
                                ver: ver,
                                material: material,
                                fabDate: fabDate
                            }, function(res) {
                                if(res.code === 200) {
                                    layer.close(index);
                                    var allocationQty = res.data;
                                    //料号中会有'.'jquery的ID选择器选不到
                                    var material_ = material.replace(".","point");
                                    var material_fabDate = material_+"_"+fabDate;
                                    $('#'+material_fabDate+"_allocationQty").html('<span>'+allocationQty+'</span>');
                                    renderMaterialMrp(material);
                                } else {
                                    layer.msg("更新MRP的供应商分配数量失败，"+res.msg);
                                    layer.close(index);
                                }
                            });
                        } else {
                            layer.msg("提交失败，"+res.msg)
                        }
                    });
                }
            });
        };

        table.render({
            elem: '#node',
            url: '/mrp/mrp/getMrpWarn',
            where: {
                ver: ver
            },
            cols: [[
                {type: 'numbers', align: 'center'},
                {field: 'product', title: '机种', align: 'center', width: 140},
                {field: 'type', title: 'TYPE', align: 'center', width: 140},
                {field: 'memo', title: '说明', align: 'center', width: 140},
                { title: '', align: 'center', width: 140, templet: function() {
                        return '<i class="layui-icon">&#xe642;</i>';
                    }}
            ]],
            size: 'sm',
            limit: 50,
            page: {layout: ['count']}
        });


        // 数据导出
        $("#bt_export").click(function() {
            var product = $('input[name=product]').val();
            var materialGroup = $('input[name=materialGroup]').val();
            var material = $('input[name=material]').val();
            var supplier = $('input[name=supplier]').val();
            exportMrpData(ver, product, materialGroup, material, supplier);
        });
        $("#bt_exportAll").click(function() {
            exportMrpData(ver);
        });
        var exportMrpData = function(v, product, materialGroup, material, supplier) {
            if(!product) product = '';
            if(!materialGroup) materialGroup='';
            if(!material) material = '';
            if(!supplier) supplier='';
            window.location.href = '/mrp/mrp/exportExcel?ver='+v+'&product='+product+'&materialGroup='+materialGroup
                + '&material='+material+'&supplier='+supplier;
        };

    });
</script>
</body>
</html>